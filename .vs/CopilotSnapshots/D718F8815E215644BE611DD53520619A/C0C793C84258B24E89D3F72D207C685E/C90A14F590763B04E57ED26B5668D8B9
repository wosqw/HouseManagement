using System.Linq;
using System;
using System.Runtime.InteropServices;
using System.Windows;
using System.Windows.Interop;
using System.Windows.Media.Imaging;

namespace HuseManagement
{
    public partial class MainWindow : Window
    {
        private HousingManagementDB _context = new HousingManagementDB();

        public MainWindow()
        {
            InitializeComponent();
            // set logo image from resources (Resources.logo is a System.Drawing.Bitmap)
            try
            {
                var bmp = Properties.Resources.logo as System.Drawing.Bitmap;
                if (bmp != null)
                {
                    var hBitmap = bmp.GetHbitmap();
                    try
                    {
                        logo.Source = Imaging.CreateBitmapSourceFromHBitmap(
                            hBitmap,
                            IntPtr.Zero,
                            System.Windows.Int32Rect.Empty,
                            BitmapSizeOptions.FromEmptyOptions());
                    }
                    finally
                    {
                        DeleteObject(hBitmap);
                    }
                }
            }
            catch
            {
                // ignore if logo resource missing or conversion fails
            }

            LoadRequests();
        }

        private void LoadRequests()
        {
            // Include related entities so bindings to Owners.Houses and Employees.FullName work
            var requests = _context.RepairRequests
                .Include("Owners.Houses")
                .Include("Employees")
                .ToList();

            RequestsListView.ItemsSource = requests;
        }

        private void AddRequest_Click(object sender, RoutedEventArgs e)
        {
            var newRequestWindow = new AddEditRequestWindow();
            if (newRequestWindow.ShowDialog() == true)
            {
                LoadRequests();
            }
        }

[System.Runtime.InteropServices.SuppressUnmanagedCodeSecurity]
internal static class NativeMethods
{
    [DllImport("gdi32.dll")]
    internal static extern bool DeleteObject(IntPtr hObject);
}

        private void EditRequest_Click(object sender, RoutedEventArgs e)
        {
            var selectedRequest = RequestsListView.SelectedItem as RepairRequests;
            if (selectedRequest != null)
            {
                var editRequestWindow = new AddEditRequestWindow(selectedRequest);
                if (editRequestWindow.ShowDialog() == true)
                {
                    LoadRequests();
                }
            }
        }

        private void DeleteRequest_Click(object sender, RoutedEventArgs e)
        {
            var selectedRequest = RequestsListView.SelectedItem as RepairRequests;
            if (selectedRequest != null)
            {
                _context.RepairRequests.Remove(selectedRequest);
                _context.SaveChanges();
                LoadRequests();
            }
        }
    }
}
