using System.Linq;
using System;
using System.IO;
using System.Windows;
using System.Windows.Interop;
using System.Windows.Media.Imaging;

namespace HuseManagement
{
    public partial class MainWindow : Window
    {
        private HousingManagementDB _context = new HousingManagementDB();

        public MainWindow()
        {
            InitializeComponent();
            // try load logo from resources: prefer Resources.logo (Bitmap), fall back to byte[] icon
            try
            {
                var logoObj = Properties.Resources.logo;
                if (logoObj is System.Drawing.Bitmap bmp)
                {
                    using (var ms = new MemoryStream())
                    {
                        bmp.Save(ms, System.Drawing.Imaging.ImageFormat.Png);
                        ms.Position = 0;
                        var bi = new BitmapImage();
                        bi.BeginInit();
                        bi.CacheOption = BitmapCacheOption.OnLoad;
                        bi.StreamSource = ms;
                        bi.EndInit();
                        bi.Freeze();
                        logo.Source = bi;
                    }
                }
                else
                {
                    var iconBytes = Properties.Resources.icon;
                    if (iconBytes != null && iconBytes.Length > 0)
                    {
                        var bi = new BitmapImage();
                        using (var ms = new MemoryStream(iconBytes))
                        {
                            bi.BeginInit();
                            bi.CacheOption = BitmapCacheOption.OnLoad;
                            bi.StreamSource = ms;
                            bi.EndInit();
                            bi.Freeze();
                        }
                        logo.Source = bi;
                    }
                }
            }
            catch
            {
                // ignore if resource missing or conversion fails
            }

            LoadRequests();
        }

        private void LoadRequests()
        {
            // Include related entities so bindings to Owners.Houses and Employees.FullName work
            var requests = _context.RepairRequests
                .Include("Owners.Houses")
                .Include("Employees")
                .ToList();

            RequestsListView.ItemsSource = requests;
        }

        private void AddRequest_Click(object sender, RoutedEventArgs e)
        {
            var newRequestWindow = new AddEditRequestWindow();
            if (newRequestWindow.ShowDialog() == true)
            {
                LoadRequests();
            }
        }

        private void EditRequest_Click(object sender, RoutedEventArgs e)
        {
            var selectedRequest = RequestsListView.SelectedItem as RepairRequests;
            if (selectedRequest != null)
            {
                var editRequestWindow = new AddEditRequestWindow(selectedRequest);
                if (editRequestWindow.ShowDialog() == true)
                {
                    LoadRequests();
                }
            }
        }

        private void DeleteRequest_Click(object sender, RoutedEventArgs e)
        {
            var selectedRequest = RequestsListView.SelectedItem as RepairRequests;
            if (selectedRequest != null)
            {
                _context.RepairRequests.Remove(selectedRequest);
                _context.SaveChanges();
                LoadRequests();
            }
        }
    }
}
